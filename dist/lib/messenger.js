"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _nodeTelegramBotApi=require("node-telegram-bot-api");var _nodeTelegramBotApi2=_interopRequireDefault(_nodeTelegramBotApi);var _message=require("./message");var _message2=_interopRequireDefault(_message);var _config=require("../config");var _config2=_interopRequireDefault(_config);var _input=require("./input");var _input2=_interopRequireDefault(_input);var _handlers=require("../handlers");var _handlers2=_interopRequireDefault(_handlers);var _index=require("../services/index");var _index2=_interopRequireDefault(_index);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var input=new _input2.default();var functions=new _index2.default();var handling=new _handlers2.default();var link=void 0;var Messenger=function(){function Messenger(){_classCallCheck(this,Messenger);if(process.env.NODE_ENV==="production"){// this.bot = new TelegramBot(Config.telegram.token, { webHook: { port: Config.telegram.port, host: Config.telegram.host } });
// this.bot.setWebHook(`${Config.telegram.externalUrl}:443/bot${Config.telegram.token}`);
this.bot=new _nodeTelegramBotApi2.default(_config2.default.telegram.token,{polling:true});}else{this.bot=new _nodeTelegramBotApi2.default(_config2.default.telegram.token,{polling:true});}}_createClass(Messenger,[{key:"listen",value:function listen(){this.bot.on("text",this.handleText.bind(this));return Promise.resolve();}},{key:"handleText",value:function handleText(msg){// format the message
var message=new _message2.default(_message2.default.mapMessage(msg));var text=message.text;// checking if asked "/how"
if(input.programHow(text)){return handling.how(this.bot,message);}// checking if asked "/link"
if(input.programLink(text)){return link?handling.link(this.bot,message,link):handling.link(this.bot,message,"You have no watched links");}// checking if asked "/start"
if(input.programStart(text)){return handling.start(this.bot,message);}// checking if asked "/stop"
if(input.programStop(text)){return handling.stop(this.bot,message);}// checking if user send valid travis-ci link
if(input.programValidLinkSended(text)){link=text;var sliced=functions.sliceMsg(text);return handling.data(this.bot,message,sliced.url);}// default - send message with help
return handling.how(this.bot,message);}}]);return Messenger;}();exports.default=Messenger;